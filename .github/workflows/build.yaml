name: Build

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  Build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      # 1. Checkout repository
      - name: 1. Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Set up Rust
      - name: 2. Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: i686-pc-windows-gnu

      # 3. Install cross-compilers
      - name: 3. Install cross-compilers
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt update && sudo apt install -y build-essential mingw-w64 jq
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install jq
          fi

      # 4. Build binaries and prepare artifacts
      - name: 4. Build binaries and prepare artifacts
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Only build these specific packages
          PACKAGES=("amodus_runtime" "amodus_injector")
          
          # Create artifacts directory
          mkdir -p artifacts

          # Build each package
          for package in "${PACKAGES[@]}"; do
            echo "Building package: $package"
            
            # Get version from workspace or package Cargo.toml
            version=$(cargo metadata --no-deps --format-version 1 | jq -r ".packages[] | select(.name == \"$package\") | .version")
            
            if [[ -z "$version" ]]; then
              echo "ERROR: Could not find version for package $package"
              continue
            fi
            
            OS=$RUNNER_OS
            echo "Building $package version $version for $OS"
            
            # Build all binaries
            cargo build --release
            
            # Determine binary name and extension
            # Binary name might differ from package name (remove amodus_ prefix)
            binary_name="${package#amodus_}"
            EXT=""
            if [[ "$OS" == "Windows" ]]; then
              EXT=".exe"
            fi
            
            BIN_PATH="target/release/${binary_name}${EXT}"
            
            echo "Looking for binary at: $BIN_PATH"
            if [[ -f "$BIN_PATH" ]]; then
              echo "Found! Copying to artifacts/"
              cp "$BIN_PATH" "artifacts/${binary_name}-${version}-${OS}${EXT}"
            else
              echo "WARNING: Binary not found at $BIN_PATH"
              echo "Trying alternative name: target/release/${package}${EXT}"
              BIN_PATH="target/release/${package}${EXT}"
              if [[ -f "$BIN_PATH" ]]; then
                echo "Found at alternative path!"
                cp "$BIN_PATH" "artifacts/${package}-${version}-${OS}${EXT}"
              else
                echo "Binary not found. Release directory contents:"
                ls -la target/release/ 2>/dev/null || echo "Release directory doesn't exist"
              fi
            fi

            # Tag package using GITHUB_TOKEN (only on one OS to avoid conflicts)
            if [[ "$OS" == "Linux" ]]; then
              git config user.name "github-actions"
              git config user.email "actions@github.com"
              TAG="${package}-${version}"
              git tag -f "$TAG" || true
              git push "https://${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "$TAG" || true
            fi
          done
          
          echo ""
          echo "=== Artifacts ready for upload ==="
          ls -lah artifacts/ 2>/dev/null || echo "No artifacts created"

      # Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries-${{ matrix.os }}
          path: artifacts/

      # Create GitHub releases (only run if triggered by tag push)
      - name: Create GitHub releases
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
