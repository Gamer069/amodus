name: Build

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  Build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      # 1. Checkout repository
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Rust
      - name: 2. Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: i686-pc-windows-gnu

      # 3. Install cross-compilers
      - name: 3. Install cross-compilers
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt update && sudo apt install -y build-essential mingw-w64 jq
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install jq
          fi

      # 4. Detect, build, tag crates and prepare artifacts
      - name: 4. Detect, build, tag crates and prepare artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Detect crates
          CRATES=$(find . -name Cargo.toml -not -path "./target/*" -exec dirname {} \;)
          echo "Found crates: $CRATES"

          # Build each crate
          for crate in $CRATES; do
            name=$(basename "$crate")
            version=$(cargo read-manifest --manifest-path "$crate/Cargo.toml" | jq -r .version)
            OS=$RUNNER_OS

            echo "Building $name version $version for $OS"
            pushd "$crate"
            cargo build --release
            popd

            # Prepare artifact
            mkdir -p artifacts
            BIN="target/release/$name"
            EXT=""
            if [[ "$OS" == "Windows" ]]; then
              EXT=".exe"
              BIN="target/release/$name.exe"
            fi
            if [[ -f "$crate/$BIN" ]]; then
              cp "$crate/$BIN" "artifacts/${name}-${version}-${OS}$EXT"
            fi

            # Tag crate using GITHUB_TOKEN
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            TAG="${name}-${version}"
            git tag -f "$TAG"
            git push "https://${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "$TAG"
          done

      # Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries
          path: artifacts/

      # Create GitHub releases
      - name: Create GitHub releases
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
